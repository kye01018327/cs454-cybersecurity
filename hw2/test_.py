from AES import *
from utils import *


def test_int_to_matrix():
    input = 0x00112233445566778899aabbccddeeff
    output = [
        [0x00, 0x44, 0x88, 0xcc],
        [0x11, 0x55, 0x99, 0xdd],
        [0x22, 0x66, 0xaa, 0xee],
        [0x33, 0x77, 0xbb, 0xff],
    ]
    assert convert_int_to_matrix(input) == output
    assert convert_matrix_to_int(output) == input


def test_sub_bytes():
    input = convert_int_to_matrix(0x19a09ae93df4c6f8e3e28d48be2b2a08)
    expected_result = 0xd4e0b81e27bfb44111985d52aef1e530
    assert convert_matrix_to_int(sub_bytes(input)) == expected_result


def test_shift_rows():
    input_state = [
        [0x00, 0x44, 0x88, 0xcc],
        [0x11, 0x55, 0x99, 0xdd],
        [0x22, 0x66, 0xaa, 0xee],
        [0x33, 0x77, 0xbb, 0xff],
    ]
    expected_output = [
        [0x00, 0x44, 0x88, 0xcc],
        [0x55, 0x99, 0xdd, 0x11],
        [0xaa, 0xee, 0x22, 0x66],
        [0xff, 0x33, 0x77, 0xbb],
    ]
    assert shift_rows(input_state) == expected_output


def test_mix_columns():
    input_state = [
        [0xdb, 0xdb, 0xdb, 0xdb],
        [0x13, 0x13, 0x13, 0x13],
        [0x53, 0x53, 0x53, 0x53],
        [0x45, 0x45, 0x45, 0x45],
    ]
    expected_output = [
        [0x8e, 0x8e, 0x8e, 0x8e],
        [0x4d, 0x4d, 0x4d, 0x4d],
        [0xa1, 0xa1, 0xa1, 0xa1],
        [0xbc, 0xbc, 0xbc, 0xbc],
    ]
    assert mix_columns(input_state) == expected_output
    

def test_add_round_key():
    state = [
        [0x32, 0x88, 0x31, 0xe0],
        [0x43, 0x5a, 0x31, 0x37],
        [0xf6, 0x30, 0x98, 0x07],
        [0xa8, 0x8d, 0xa2, 0x34],
    ]
    round_key = [
        [0x2b, 0x28, 0xab, 0x09],
        [0x7e, 0xae, 0xf7, 0xcf],
        [0x15, 0xd2, 0x15, 0x4f],
        [0x16, 0xa6, 0x88, 0x3c],
    ]
    expected_output = [
        [0x19, 0xa0, 0x9a, 0xe9],
        [0x3d, 0xf4, 0xc6, 0xf8],
        [0xe3, 0xe2, 0x8d, 0x48],
        [0xbe, 0x2b, 0x2a, 0x08],
    ]
    assert add_round_key(state, round_key) == expected_output


def test_key_expansion():
    input = [
        [0x2b, 0x7e, 0x15, 0x16],
        [0x28, 0xae, 0xd2, 0xa6],
        [0xab, 0xf7, 0x15, 0x88],
        [0x09, 0xcf, 0x4f, 0x3c]
    ]
    expected_first_8_words = [
        [0x2b, 0x7e, 0x15, 0x16],
        [0x28, 0xae, 0xd2, 0xa6],
        [0xab, 0xf7, 0x15, 0x88],
        [0x09, 0xcf, 0x4f, 0x3c],
        [0xa0, 0xfa, 0xfe, 0x17],
        [0x88, 0x54, 0x2c, 0xb1],
        [0x23, 0xa3, 0x39, 0x39],
        [0x2a, 0x6c, 0x76, 0x05]
    ]
    assert key_expansion(input)[:8] == expected_first_8_words


def test_aes_encrypt():
    plaintext = [
        [0x32, 0x88, 0x31, 0xe0],
        [0x43, 0x5a, 0x31, 0x37],
        [0xf6, 0x30, 0x98, 0x07],
        [0xa8, 0x8d, 0xa2, 0x34],
    ]
    key = [
        [0x2b, 0x7e, 0x15, 0x16],
        [0x28, 0xae, 0xd2, 0xa6],
        [0xab, 0xf7, 0x15, 0x88],
        [0x09, 0xcf, 0x4f, 0x3c],
    ]
    ciphertext = [
        [0x39, 0x02, 0xdc, 0x19],
        [0x25, 0xdc, 0x11, 0x6a],
        [0x84, 0x09, 0x85, 0x0b],
        [0x1d, 0xfb, 0x97, 0x32],
    ]
    assert aes_encrypt(plaintext, key) == ciphertext
